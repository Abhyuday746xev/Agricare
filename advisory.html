<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advisory - Agricare</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Fade-in animation for advisory box */
    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col relative">

  <!-- Background image with overlay -->
  <div class="absolute inset-0">
    <img src="image/img.jpeg" alt="Background" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-white/65 backdrop-blur-sm"></div>
  </div>

  <div class="flex-grow relative z-10">

    <!-- Header -->
    <header class="max-w-7xl mx-auto px-6 py-6 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="image/logo.jpeg" alt="AgriCare Logo" class="w-10 h-10 rounded-lg object-cover">
        <div>
          <h1 class="text-lg font-semibold text-slate-800">Agricare Advisory</h1>
          <p class="text-xs text-slate-500">Smart farming ¬∑ Sustainable yields</p>
        </div>
      </div>
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="home.html" class="ml-4 px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm hover:bg-emerald-700 transition">Home</a>
      </nav>
      <div class="flex items-center gap-2">
        <select id="languageSelect" class="border rounded-lg p-1 text-sm">
          <option value="en" selected>English</option>
          <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>
          <option value="es">Espa√±ol</option>
          <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
        </select>
        <button class="md:hidden p-2 rounded-md bg-emerald-100">‚ò∞</button>
      </div>
    </header>

    <!-- Form Section -->
    <div class="flex justify-center items-center mt-12 px-6">
      <div class="bg-white/95 rounded-2xl shadow-xl p-8 w-full max-w-lg backdrop-blur-sm">
        <h2 class="text-2xl font-bold mb-6 text-slate-800 text-center">Give Advisory</h2>
        <form id="advisoryForm" class="space-y-4">
          <div>
            <label for="crop" class="block text-sm font-medium">Crop</label>
            <select id="crop" class="w-full border rounded-lg p-2 mt-1 focus:ring-emerald-500 focus:border-emerald-500" required></select>
          </div>
          <div>
            <label for="district" class="block text-sm font-medium">District</label>
            <select id="district" class="w-full border rounded-lg p-2 mt-1 focus:ring-emerald-500 focus:border-emerald-500" required></select>
          </div>
          <div>
            <label for="subdistrict" class="block text-sm font-medium">Subdistrict</label>
            <select id="subdistrict" class="w-full border rounded-lg p-2 mt-1 focus:ring-emerald-500 focus:border-emerald-500" required></select>
          </div>
          <div>
            <label for="soil" class="block text-sm font-medium">Soil</label>
            <select id="soil" class="w-full border rounded-lg p-2 mt-1 focus:ring-emerald-500 focus:border-emerald-500" required></select>
          </div>
          <div>
            <label for="severity" class="block text-sm font-medium">Severity</label>
            <select id="severity" class="w-full border rounded-lg p-2 mt-1 focus:ring-emerald-500 focus:border-emerald-500" required>
              <option value="">Select severity</option>
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
            </select>
          </div>
          <button type="submit" class="w-full bg-emerald-600 text-white py-2 rounded-lg mt-4 hover:bg-emerald-700 transition">Give Advisory</button>
        </form>

        <!-- Dynamic advisory message -->
        <div id="formMsg" class="mt-4 text-sm hidden p-3 rounded-xl shadow-sm fade-in"></div>
        <!-- Speaker button -->
        <button id="speakBtn" class="mt-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2" style="display:none;">
          üîä Speak Advisory
        </button>

      </div>
    </div>

  </div>

  <!-- Footer -->
  <footer class="mt-auto bg-slate-900 text-white text-center py-4 relative z-10">
    &copy; 2025 Agricare Advisory. All Rights Reserved.
  </footer>

  <script>
    const cropSelect = document.getElementById('crop');
    const districtSelect = document.getElementById('district');
    const subdistrictSelect = document.getElementById('subdistrict');
    const soilSelect = document.getElementById('soil');
    const severitySelect = document.getElementById('severity');
    const formMsg = document.getElementById('formMsg');
    const form = document.getElementById('advisoryForm');
    const speakBtn = document.getElementById('speakBtn');
    const languageSelect = document.getElementById('languageSelect');

    // --- Translation dictionary ---
    const translations = {
      en: { crop:"Crop", district:"District", subdistrict:"Subdistrict", soil:"Soil", severity:"Severity",
            giveAdvisory:"Give Advisory", selectSeverity:"Select severity", low:"Low", medium:"Medium", high:"High",
            speakAdvisory:"Speak Advisory", advisoryGenerated:"Advisory generated" },
      hi: { crop:"‡§´‡§∏‡§≤", district:"‡§ú‡§ø‡§≤‡§æ", subdistrict:"‡§â‡§™-‡§ú‡§ø‡§≤‡§æ", soil:"‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä", severity:"‡§§‡•Ä‡§µ‡•ç‡§∞‡§§‡§æ",
            giveAdvisory:"‡§∏‡§≤‡§æ‡§π ‡§¶‡•á‡§Ç", selectSeverity:"‡§§‡•Ä‡§µ‡•ç‡§∞‡§§‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç", low:"‡§ï‡§Æ", medium:"‡§Æ‡§ß‡•ç‡§Ø‡§Æ", high:"‡§â‡§ö‡•ç‡§ö",
            speakAdvisory:"‡§∏‡§≤‡§æ‡§π ‡§™‡§¢‡§º‡•á‡§Ç", advisoryGenerated:"‡§∏‡§≤‡§æ‡§π ‡§§‡•à‡§Ø‡§æ‡§∞" },
      es: { crop:"Cultivo", district:"Distrito", subdistrict:"Subdistrito", soil:"Suelo", severity:"Severidad",
            giveAdvisory:"Dar Asesor√≠a", selectSeverity:"Seleccionar severidad", low:"Baja", medium:"Media", high:"Alta",
            speakAdvisory:"Leer Asesor√≠a", advisoryGenerated:"Asesor√≠a generada" },
      ta: { crop:"‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç", district:"‡ÆÆ‡Ææ‡Æµ‡Æü‡Øç‡Æü‡ÆÆ‡Øç", subdistrict:"‡Æ§‡Øä‡Æï‡ØÅ‡Æ§‡Æø", soil:"‡ÆÆ‡Æ£‡Øç", severity:"ÿ¥ÿØŸëÿ™",
            giveAdvisory:"‡ÆÜ‡Æ≤‡Øã‡Æö‡Æ©‡Øà ‡Æï‡Øä‡Æü‡ØÅ", selectSeverity:"ÿ¥ÿØŸëÿ™ ‡Æ§‡Øá‡Æ∞‡Øç‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç", low:"‡Æï‡ØÅ‡Æ±‡Øà‡Æµ‡ØÅ", medium:"‡ÆÆ‡Æ§‡Øç‡Æ§‡Æø‡ÆØ‡ÆÆ‡Øç", high:"‡Æâ‡ÆØ‡Æ∞‡Øç",
            speakAdvisory:"‡ÆÜ‡Æ≤‡Øã‡Æö‡Æ©‡Øà‡ÆØ‡Øà ‡Æµ‡Ææ‡Æö‡Æø", advisoryGenerated:"‡ÆÜ‡Æ≤‡Øã‡Æö‡Æ©‡Øà ‡Æâ‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ§‡ØÅ" }
    };

    function updateLanguage(lang) {
      const t = translations[lang] || translations['en'];
      document.querySelector("label[for='crop']").textContent = t.crop;
      document.querySelector("label[for='district']").textContent = t.district;
      document.querySelector("label[for='subdistrict']").textContent = t.subdistrict;
      document.querySelector("label[for='soil']").textContent = t.soil;
      document.querySelector("label[for='severity']").textContent = t.severity;

      severitySelect.options[0].textContent = t.selectSeverity;
      severitySelect.options[1].textContent = t.low;
      severitySelect.options[2].textContent = t.medium;
      severitySelect.options[3].textContent = t.high;

      form.querySelector("button[type='submit']").textContent = t.giveAdvisory;
      speakBtn.textContent = `üîä ${t.speakAdvisory}`;
    }

    languageSelect.addEventListener('change', (e) => updateLanguage(e.target.value));
    updateLanguage('en'); // default

    // Load dropdowns
    async function loadCrops() {
      try { const res = await fetch('https://agricare-production.up.railway.app/crops'); const data = await res.json();
        cropSelect.innerHTML = '<option value="">Select crop</option>';
        data.forEach(crop => cropSelect.innerHTML += `<option value="${crop.crop_id}">${crop.crop_name}</option>`);
      } catch (err) { console.error(err); }
    }
    async function loadDistricts() {
      try { const res = await fetch('https://agricare-production.up.railway.app/districts'); const data = await res.json();
        districtSelect.innerHTML = '<option value="">Select district</option>';
        data.forEach(d => districtSelect.innerHTML += `<option value="${d.district_id}">${d.name}</option>`);
      } catch (err) { console.error(err); }
    }
    async function loadSubdistricts(districtId) {
      try { const res = await fetch(`https://agricare-production.up.railway.app/subdistricts/${districtId}`);
        const data = await res.json();
        subdistrictSelect.innerHTML = '<option value="">Select subdistrict</option>';
        data.forEach(s => subdistrictSelect.innerHTML += `<option value="${s.subdistrict_id}">${s.name}</option>`);
      } catch (err) { console.error(err); }
    }
    async function loadSoils() {
      try { const res = await fetch('https://agricare-production.up.railway.app/soils'); const data = await res.json();
        soilSelect.innerHTML = '<option value="">Select soil</option>';
        data.forEach(s => soilSelect.innerHTML += `<option value="${s.soil_id}">${s.soil_name}</option>`);
      } catch (err) { console.error(err); }
    }

    window.onload = () => { loadCrops(); loadDistricts(); loadSoils(); };

    districtSelect.addEventListener('change', () => {
      const districtId = districtSelect.value;
      if (!districtId) { subdistrictSelect.innerHTML = '<option value="">Select subdistrict</option>'; return; }
      loadSubdistricts(districtId);
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = { crop: cropSelect.value, district: districtSelect.value, subdistrict: subdistrictSelect.value, soil: soilSelect.value, severity: severitySelect.value };
      if (!payload.crop || !payload.district || !payload.subdistrict || !payload.soil || !payload.severity) { alert("All fields are required"); return; }
      try {
        const saveRes = await fetch('https://agricare-production.up.railway.app/advisory', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const saveData = await saveRes.json();
        if (!saveRes.ok) { alert(saveData.message || "Failed"); return; }

        const advRes = await fetch('https://agricare-production.up.railway.app/get-advisory', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ crop: payload.crop, severity: payload.severity }) });
        const advData = await advRes.json();

        formMsg.textContent = advData.advisory || advData.message || translations[languageSelect.value].advisoryGenerated;
        formMsg.classList.remove('hidden','bg-emerald-100','bg-yellow-100','bg-red-100','text-emerald-800','text-yellow-800','text-red-800');

        if (payload.severity === "Low") formMsg.classList.add("bg-emerald-100","text-emerald-800");
        else if (payload.severity === "Medium") formMsg.classList.add("bg-yellow-100","text-yellow-800");
        else if (payload.severity === "High") formMsg.classList.add("bg-red-100","text-red-800");

        formMsg.classList.add('fade-in');
        speakBtn.style.display = 'inline-flex';

        form.reset();
        subdistrictSelect.innerHTML = '<option value="">Select subdistrict</option>';
        soilSelect.innerHTML = '<option value="">Select soil</option>';
        loadSoils();

      } catch (err) { console.error(err); alert("Server error"); }
    });

    speakBtn.addEventListener('click', () => {
      const text = formMsg.textContent.trim();
      if (!text) return alert("No advisory to speak!");
      const utterance = new SpeechSynthesisUtterance(text);
      const lang = languageSelect.value;
      utterance.lang = lang==='hi'?'hi-IN':lang==='es'?'es-ES':lang==='ta'?'ta-IN':'en-US';
      speechSynthesis.speak(utterance);
    });

    // Chatbot logic (unchanged)
    const chatToggle = document.getElementById('chatToggle');
    const chatWindow = document.getElementById('chatWindow');
    const closeChat = document.getElementById('closeChat');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendChat = document.getElementById('sendChat');

    chatToggle.addEventListener('click', () => chatWindow.classList.toggle('hidden'));
    closeChat.addEventListener('click', () => chatWindow.classList.add('hidden'));
    sendChat.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => { if(e.key==='Enter') sendMessage(); });

    async function sendMessage() {
      const query = chatInput.value.trim();
      if(!query) return;
      const userMsg = document.createElement('div');
      userMsg.className = "text-right text-sm bg-emerald-100 p-2 rounded-lg";
      userMsg.textContent = query;
      chatMessages.appendChild(userMsg);
      chatInput.value="";
      chatMessages.scrollTop=chatMessages.scrollHeight;

      const loadingMsg = document.createElement('div');
      loadingMsg.className = "text-gray-500 italic text-sm";
      loadingMsg.textContent="Thinking...";
      chatMessages.appendChild(loadingMsg);
      chatMessages.scrollTop=chatMessages.scrollHeight;

      try{
        const res = await fetch('https://agricare-production.up.railway.app/chat',{ method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ query }) });
        const data = await res.json();
        chatMessages.removeChild(loadingMsg);
        const botMsg = document.createElement('div');
        botMsg.className = "text-left text-sm bg-gray-100 p-2 rounded-lg";
        botMsg.textContent = data.answer || "Sorry, I couldn‚Äôt process that.";
        chatMessages.appendChild(botMsg);
        chatMessages.scrollTop=chatMessages.scrollHeight;
      } catch(err){ console.error(err); loadingMsg.textContent="Error fetching response!"; }
    }
  </script>

  <!-- Chatbot Toggle Button -->
  <button id="chatToggle" class="fixed bottom-6 right-6 bg-emerald-600 text-white p-4 rounded-full shadow-lg hover:bg-emerald-700 z-50">üí¨</button>

  <!-- Chatbot Window -->
  <div id="chatWindow" class="hidden fixed bottom-20 right-6 w-80 bg-white shadow-xl rounded-2xl border border-gray-200 flex flex-col overflow-hidden z-50">
    <div class="bg-emerald-600 text-white p-3 font-semibold flex justify-between items-center">
      AgriCare Chatbot
      <button id="closeChat" class="text-white font-bold">‚úï</button>
    </div>
    <div id="chatMessages" class="flex-1 p-3 space-y-2 overflow-y-auto text-sm"></div>
    <div class="p-3 border-t flex">
      <input id="chatInput" type="text" placeholder="Ask your query..." class="flex-1 border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"/>
      <button id="sendChat" class="ml-2 bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700">Send</button>
    </div>
  </div>

</body>
</html>
