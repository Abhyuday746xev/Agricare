<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advisory - Agricare</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Fade-in animation for advisory box */
    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col relative">

  <!-- Background image with overlay -->
  <div class="absolute inset-0">
    <img src="image/img.jpeg" alt="Background" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-white/65 backdrop-blur-sm"></div>
  </div>

  <div class="flex-grow relative z-10">

    <!-- Header -->
    <header class="max-w-7xl mx-auto px-6 py-6 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="image/logo.jpeg" alt="AgriCare Logo" class="w-10 h-10 rounded-lg object-cover">
        <div>
          <h1 class="text-lg font-semibold text-slate-800">Agricare Advisory</h1>
          <p class="text-xs text-slate-500">Smart farming Â· Sustainable yields</p>
        </div>
      </div>
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="home.html" class="ml-4 px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm hover:bg-emerald-700 transition">Home</a>
      </nav>
      <button class="md:hidden p-2 rounded-md bg-emerald-100">â˜°</button>
    </header>

    <!-- Form Section -->
    <div class="flex justify-center items-center mt-12 px-6">
      <div class="bg-white/95 rounded-2xl shadow-xl p-8 w-full max-w-lg backdrop-blur-sm">
        <h2 class="text-2xl font-bold mb-6 text-slate-800 text-center">Give Advisory</h2>
        <form id="advisoryForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium">Crop</label>
            <select id="crop" class="w-full border rounded-lg p-2 mt-1 focus:ring-emerald-500 focus:border-emerald-500" required></select>
          </div>
          <div>
            <label class="block text-sm font-medium">District</label>
            <select id="district" class="w-full border rounded-lg p-2 mt-1 focus:ring-emerald-500 focus:border-emerald-500" required></select>
          </div>
          <div>
            <label class="block text-sm font-medium">Subdistrict</label>
            <select id="subdistrict" class="w-full border rounded-lg p-2 mt-1 focus:ring-emerald-500 focus:border-emerald-500" required></select>
          </div>
          <div>
            <label class="block text-sm font-medium">Soil</label>
            <select id="soil" class="w-full border rounded-lg p-2 mt-1 focus:ring-emerald-500 focus:border-emerald-500" required></select>
          </div>
          <div>
            <label class="block text-sm font-medium">Severity</label>
            <select id="severity" class="w-full border rounded-lg p-2 mt-1 focus:ring-emerald-500 focus:border-emerald-500" required>
              <option value="">Select severity</option>
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
            </select>
          </div>
          <button type="submit" class="w-full bg-emerald-600 text-white py-2 rounded-lg mt-4 hover:bg-emerald-700 transition">Give Advisory</button>
        </form>

        <!-- Dynamic advisory message -->
        <div id="formMsg" class="mt-4 text-sm hidden p-3 rounded-xl shadow-sm fade-in"></div>
        <!-- Speaker button -->
        <button id="speakBtn" class="mt-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2" style="display:none;">
          ðŸ”Š Speak Advisory
        </button>

      </div>
    </div>

  </div>

  <!-- Footer -->
  <footer class="mt-auto bg-slate-900 text-white text-center py-4 relative z-10">
    &copy; 2025 Agricare Advisory. All Rights Reserved.
  </footer>

  <script>
    const cropSelect = document.getElementById('crop');
    const districtSelect = document.getElementById('district');
    const subdistrictSelect = document.getElementById('subdistrict');
    const soilSelect = document.getElementById('soil');
    const severitySelect = document.getElementById('severity');
    const formMsg = document.getElementById('formMsg');
    const form = document.getElementById('advisoryForm');
    const speakBtn = document.getElementById('speakBtn');

    // Load dropdowns
    async function loadCrops() {
      try {
        const res = await fetch('https://agricare-production.up.railway.app/crops');
        const data = await res.json();
        cropSelect.innerHTML = '<option value="">Select crop</option>';
        data.forEach(crop => cropSelect.innerHTML += `<option value="${crop.crop_id}">${crop.crop_name}</option>`);
      } catch (err) { console.error(err); }
    }

    async function loadDistricts() {
      try {
        const res = await fetch('https://agricare-production.up.railway.app/districts');
        const data = await res.json();
        districtSelect.innerHTML = '<option value="">Select district</option>';
        data.forEach(d => districtSelect.innerHTML += `<option value="${d.district_id}">${d.name}</option>`);
      } catch (err) { console.error(err); }
    }

    async function loadSubdistricts(districtId) {
      try {
        const res = await fetch(`https://agricare-production.up.railway.app/subdistricts/${districtId}`);
        const data = await res.json();
        subdistrictSelect.innerHTML = '<option value="">Select subdistrict</option>';
        data.forEach(s => subdistrictSelect.innerHTML += `<option value="${s.subdistrict_id}">${s.name}</option>`);
      } catch (err) { console.error(err); }
    }

    async function loadSoils() {
      try {
        const res = await fetch('https://agricare-production.up.railway.app/soils');
        const data = await res.json();
        soilSelect.innerHTML = '<option value="">Select soil</option>';
        data.forEach(s => soilSelect.innerHTML += `<option value="${s.soil_id}">${s.soil_name}</option>`);
      } catch (err) { console.error(err); }
    }

    // Initialize
    window.onload = () => {
      loadCrops();
      loadDistricts();
      loadSoils();
    };

    // When district changes
    districtSelect.addEventListener('change', () => {
      const districtId = districtSelect.value;
      if (!districtId) {
        subdistrictSelect.innerHTML = '<option value="">Select subdistrict</option>';
        return;
      }
      loadSubdistricts(districtId);
    });

    // Submit form
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        crop: cropSelect.value,
        district: districtSelect.value,
        subdistrict: subdistrictSelect.value,
        soil: soilSelect.value,
        severity: severitySelect.value
      };

      if (!payload.crop || !payload.district || !payload.subdistrict || !payload.soil || !payload.severity) {
        alert("All fields are required");
        return;
      }

      try {
        // Save advisory
        const saveRes = await fetch('https://agricare-production.up.railway.app/advisory', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const saveData = await saveRes.json();
        if (!saveRes.ok) { alert(saveData.message || "Failed"); return; }

        // Fetch dynamic advisory text
        const advRes = await fetch('https://agricare-production.up.railway.app/get-advisory', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ crop: payload.crop, severity: payload.severity })
        });
        const advData = await advRes.json();

        // Show advisory with severity-based styling
        formMsg.textContent = advData.advisory || advData.message || "Advisory generated";
        formMsg.classList.remove('hidden', 'bg-emerald-100', 'bg-yellow-100', 'bg-red-100', 'text-emerald-800', 'text-yellow-800', 'text-red-800');
        
        if (payload.severity === "Low") {
          formMsg.classList.add("bg-emerald-100", "text-emerald-800");
        } else if (payload.severity === "Medium") {
          formMsg.classList.add("bg-yellow-100", "text-yellow-800");
        } else if (payload.severity === "High") {
          formMsg.classList.add("bg-red-100", "text-red-800");
        }

        formMsg.classList.add('fade-in');

        // Show speaker button
        speakBtn.style.display = 'inline-flex';

        // Reset form
        form.reset();
        subdistrictSelect.innerHTML = '<option value="">Select subdistrict</option>';
        soilSelect.innerHTML = '<option value="">Select soil</option>';
        loadSoils();

      } catch (err) {
        console.error(err);
        alert("Server error");
      }
    });

    // Text-to-Speech
    speakBtn.addEventListener('click', () => {
      const text = formMsg.textContent.trim();
      if (!text) return alert("No advisory to speak!");
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US';
      speechSynthesis.speak(utterance);
    });
  </script>

</body>
</html>
